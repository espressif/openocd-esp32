build_stub_images:
  stage: stub_build
  image: ${TEST_APP_IDF_LATEST_DOCKER_IMAGE}
  tags:
    - build
    - internet
    - brew
  variables:
    GIT_SUBMODULE_STRATEGY: none
    GIT_SUBMODULE_DEPTH: "0"
  artifacts:
    paths:
      - contrib/loaders/flash/espressif/images/
  script:
    - git submodule update --init --recursive contrib/loaders/flash/espressif/esp-stub-lib
    - cd contrib/loaders/flash/espressif
    - ./build.sh all

.test_stublib_template:
  stage: test_stub_lib
  image: $CI_DOCKER_REGISTRY/target-test-env-v6.0:2
  tags:
    - $CHIP_NAME
    - jtag
  allow_failure: true
  variables:
    RUNNER_SCRIPT_TIMEOUT: 5m
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_stublib_test"
    TEST_RUN_EXTRA_OPTS: "-r --no-load --no-gdb -b ${TEST_BOARD} -p test_oocd.StubTestsSimple"
  artifacts:
    paths:
      - $TEST_RUN_DIR/debug_backend_tests.log
    reports:
      junit:
        - $TEST_RUN_DIR/results/*
    when: always
    expire_in: 1 week
  needs:
    - job: build_linux_arm64_test
    - job: build_linux_armhf_test
  before_script:
    - pip install unittest-xml-reporting --no-deps
    - >
      machine="$(uname -m)";
      if [[ "$machine" == "armv7l" ]] ; then
        export PLATFORM_NAME="linux-armhf-test";
      elif [[ "$machine" == "aarch64" ]] ; then
        export PLATFORM_NAME="linux-arm64-test";
      fi;
      echo "PLATFORM_NAME: ${PLATFORM_NAME}";
  script:
    - mkdir ${TEST_RUN_DIR}
    - ARCHIVE_NAME=$(cat ${DIST_ART_DIR}/dist_name_${PLATFORM_NAME})
    - tar -C ${TEST_RUN_DIR} -x -m -f ${DIST_ART_DIR}/${ARCHIVE_NAME}
    - export DIST_DIR=${PWD}/${TEST_RUN_DIR}/${DIST_INSTALLED_DIR}
    - export PYTHONPATH=$PWD/${TEST_RUN_DIR}:$PWD/testing/esp/py_debug_backend
    - testing/esp/run_tests.py -o $DIST_DIR/bin/openocd -s $DIST_DIR/share/openocd/scripts -a $PWD/$TEST_RUN_DIR -d 4 -l $PWD/$TEST_RUN_DIR/debug_backend_tests.log -tr x -to $PWD/$TEST_RUN_DIR/results $TEST_RUN_EXTRA_OPTS

test_stublib_esp32:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32
    TEST_BOARD: "esp32-wrover-kit-3.3v"

test_stublib_esp32s2:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32s2
    TEST_BOARD: "esp32s2-devkitj"

test_stublib_esp32s3:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32s3
    TEST_BOARD: "esp32s3-ftdi"

test_stublib_esp32c2:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32c2
    TEST_BOARD: "esp32c2-ftdi"

test_stublib_esp32c3:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32c3
    TEST_BOARD: "esp32c3-ftdi"

test_stublib_esp32c5:
  extends:
    - .test_stublib_template
  tags:
    - esp32c5
    - usb_serial_jtag
  variables:
    CHIP_NAME: esp32c5
    TEST_BOARD: "esp32c5-builtin"

test_stublib_esp32c6:
  extends:
    - .test_stublib_template
  tags:
    - esp32c6
    - usb_serial_jtag
  variables:
    CHIP_NAME: esp32c6
    TEST_BOARD: "esp32c6-builtin"

test_stublib_esp32c61:
  extends:
    - .test_stublib_template
  tags:
    - esp32c61
    - usb_serial_jtag
  variables:
    CHIP_NAME: esp32c61
    TEST_BOARD: "esp32c61-builtin"

test_stublib_esp32h2:
  extends:
    - .test_stublib_template
  tags:
    - esp32h2
    - usb_serial_jtag
  variables:
    CHIP_NAME: esp32h2
    TEST_BOARD: "esp32h2-builtin"

test_stublib_esp32h21:
  extends:
    - .test_stublib_template
  tags:
    - esp32h21
    - usb_serial_jtag
  variables:
    CHIP_NAME: esp32h21
    TEST_BOARD: "esp32h21-builtin"

test_stublib_esp32p4:
  extends:
    - .test_stublib_template
  variables:
    CHIP_NAME: esp32p4
    TEST_BOARD: "esp32p4-ftdi"
