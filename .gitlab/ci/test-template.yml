.tests_template:
  tags:
    - $CHIP_NAME
    - jtag
  stage: test
  variables:
    RUNNER_SCRIPT_TIMEOUT: 60m
    OOCD_CMDS: "set VAR 1" # default command to avoid missing argument error.
    TEST_RUN_EXTRA_OPTS: "-r -i ${IDF_RELEASE_TAG} ${TEST_RUN_BOARD_OPTS}"
    ESPTOOL_PORT: "/dev/serial_ports/ttyUSB-esp32"
  artifacts:
    paths:
      - $TEST_RUN_DIR/debug_backend_tests.log
      - $TEST_RUN_DIR/esp_cov_files
      - $TEST_RUN_DIR/sanitizer_errors.log
    reports:
      junit:
        - $TEST_RUN_DIR/results/*
    when: always
    expire_in: 1 week
  before_script:
    - export GCOV_PREFIX=$PWD/$TEST_RUN_DIR
    - export GCOV_PREFIX_STRIP=2
    - pip install unittest-xml-reporting --no-deps
    - pip install pygdbmi==0.9.0.2
    - ./tools/install-rom-elfs.sh
    - >
      machine="$(uname -m)";
      if [[ "$machine" == "armv7l" ]] ; then
        export CONF_HOST="arm-linux-gnueabihf";
        export PLATFORM_NAME="linux-armhf-test";
      elif [[ "$machine" == "aarch64" ]] ; then
        export CONF_HOST="aarch64-linux-gnu";
        export PLATFORM_NAME="linux-arm64-test";
      fi;
      echo "PLATFORM_NAME: ${PLATFORM_NAME}";
      if [[ $SCHEDULE_TYPE == "run_sanitizer_tests" ]] ; then
        export ASAN_OPTIONS="detect_invalid_pointer_pairs=2:print_stacktrace=1:strict_string_checks=1:halt_on_error=0:allocator_may_return_null=1";
        export TEST_SANITIZERS=1;
        cp ${CONF_HOST}/lib* /usr/lib;
        export TEST_RUN_EXTRA_OPTS="${TEST_RUN_EXTRA_OPTS} -e *.*.test_semihost_args";
      fi;
      if [[ $IDF_RELEASE_TAG != "latest" || $CI_FULL_RUN != "1" ]] ; then
        export TEST_RUN_EXTRA_OPTS="${TEST_RUN_EXTRA_OPTS} -e *.*.test_big_binary *.*.test_big_binary_compressed";
      fi
  script:
    - !reference [.submodules_mirror_update, script]
    - !reference [.export_toolchain, script]
    - . $PWD/${TEST_RUN_DIR}/gen_ut_app/gcov_data/gcov_env.sh
    - !reference [.run_tests_linux, script]
  after_script:
    - >
      command_arg+="--include src/jtag/drivers/*esp_*.gcno ";
      command_arg+="--include src/jtag/drivers/*esp_*.gcda ";
      command_arg+="--include src/target/espressif/*.gcno ";
      command_arg+="--include src/target/espressif/*.gcda ";
      command_arg+="--include src/target/xtensa/*.gcno ";
      command_arg+="--include src/target/xtensa/*.gcda ";
      command_arg+="--include src/target/riscv/*.gcno ";
      command_arg+="--include src/target/riscv/*.gcda ";
      command_arg+="--include src/flash/nor/*esp32*.gcno ";
      command_arg+="--include src/flash/nor/*esp32*.gcda ";
      command_arg+="--include src/flash/nor/*esp_*.gcno ";
      command_arg+="--include src/flash/nor/*esp_*.gcda ";
      command_arg+="--include src/rtos/*.gcno ";
      command_arg+="--include src/rtos/*.gcda ";
    - mkdir ${TEST_RUN_DIR}/esp_cov_files
    - rsync -a --prune-empty-dirs --include '*/' ${command_arg} --exclude '*' ${TEST_RUN_DIR}/${DIST_INSTALLED_DIR}/_build ${TEST_RUN_DIR}/esp_cov_files
    - cp ${PWD}/${TEST_RUN_DIR}/${DIST_INSTALLED_DIR}/bin/gcov ${TEST_RUN_DIR}/esp_cov_files

.tests_master_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v6.1:1
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    ESP_GDB_TOOLCHAIN: "${ESP_V6_1X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V6_1X_TOOLCHAIN_VER}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}"
    IDF_RELEASE_TAG: "latest"

.tests_master_riscv_template:
  extends: .tests_master_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V6_1X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"

.tests_v6.0.x_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v6.0:2
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    ESP_GDB_TOOLCHAIN: "${ESP_V6_0X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V6_0X_TOOLCHAIN_VER}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_idf6.0.x"
    IDF_RELEASE_TAG: "${TEST_APP_IDF6_0_X_RELEASE_TAG}"

.tests_v6.0.x_riscv_template:
  extends: .tests_v6.0.x_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V6_0X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"

.tests_v5.5.x_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v5.5:2
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_5X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V5_5X_TOOLCHAIN_VER}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_idf5.5.x"
    IDF_RELEASE_TAG: "${TEST_APP_IDF5_5_X_RELEASE_TAG}"

.tests_v5.5.x_riscv_template:
  extends: .tests_v5.5.x_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_5X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"

.tests_v5.4.x_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v5.4:2
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_4X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V5_4X_TOOLCHAIN_VER}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_idf5.4.x"
    IDF_RELEASE_TAG: "${TEST_APP_IDF5_4_X_RELEASE_TAG}"

.tests_v5.4.x_riscv_template:
  extends: .tests_v5.4.x_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_4X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"

.tests_v5.3.x_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v5.3:1
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_3X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V5_3X_TOOLCHAIN_VER}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_idf5.3.x"
    IDF_RELEASE_TAG: "${TEST_APP_IDF5_3_X_RELEASE_TAG}"

.tests_v5.3.x_riscv_template:
  extends: .tests_v5.3.x_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_3X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"

.tests_v5.2.x_template:
  extends: .tests_template
  image: $CI_DOCKER_REGISTRY/target-test-env-v5.2:2
  variables:
    CHIP_TEST_TOOLCHAIN: "xtensa-${CHIP_NAME}"
    TEST_RUN_DIR: "build_test_app_${CHIP_NAME}_idf5.2.x"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_2X_XTENSA_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "xtensa-esp"
    ESP_TOOLCHAIN: "${ESP_V5_2X_TOOLCHAIN_VER}"
    IDF_RELEASE_TAG: "${TEST_APP_IDF5_2_X_RELEASE_TAG}"

.tests_v5.2.x_riscv_template:
  extends: .tests_v5.2.x_template
  variables:
    CHIP_TEST_TOOLCHAIN: "riscv32-esp"
    ESP_GDB_TOOLCHAIN: "${ESP_V5_2X_RISCV_GDB_TOOLCHAIN}"
    TOOLCHAIN_PREFIX: "riscv32-esp"
